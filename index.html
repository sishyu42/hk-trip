<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>È¶ôÊ∏ØTrip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Playfair+Display:ital,wght@0,900;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@1,700&display=swap" rel="stylesheet">   
    <style>
        :root { --xmas-red: #A61B1B; --xmas-green: #044A05; --hk-gold: #D4AF37; --bg-cream: #FDFCF0; }
        body { background-color: var(--bg-cream); font-family: 'Noto Sans TC', sans-serif; color: #1F2937; overflow-x: hidden; height: 100vh; }
        .header-bg { background-image: linear-gradient(to bottom, rgba(166, 27, 27,0.4), rgba(166, 27, 27, 0.7)), url('./images/bg.jpeg'); background-size: cover; background-position: center; border-bottom: 3px solid var(--hk-gold); }
        .brand-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 1px;
            color: #FFFFFF; 
            text-shadow: 0 0 7px #fff, 0 0 15px var(--hk-gold), 0 0 30px var(--hk-gold), 0 0 50px var(--xmas-red), 3px 4px 8px rgba(0,0,0,0.6);
        }
        .xmas-red { background-color: var(--xmas-red); }
        .xmas-green { background-color: var(--xmas-green); }
        .text-xmas-red { color: var(--xmas-red); }
        .text-hk-gold { color: var(--hk-gold); }
        .snowflake { position: absolute; color: white; opacity: 0.5; font-size: 10px; animation: fall linear infinite; pointer-events: none; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .ticket-stub { background: #FFF9E6; border: 3px solid var(--hk-gold); border-style: dashed; border-radius: 12px; }
        .timeline-path { position: absolute; left: 58px; top: 0; bottom: 0; width: 2px; background: repeating-linear-gradient(to bottom, #D4AF37 0, #D4AF37 5px, transparent 5px, transparent 10px); z-index: 1; }
        .modal-enter-active, .modal-leave-active { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(20px); }
        .crop-container img { display: block; max-width: 100%; }
    </style>
</head>
<body class="flex flex-col">

<div id="app" class="flex flex-col h-full w-full max-md mx-auto relative bg-[#FDFCF0] shadow-2xl overflow-hidden border-x-4 border-xmas-red">
    
    <div class="absolute top-2 right-2 z-[100] flex items-center space-x-1 bg-black/20 px-2 py-0.5 rounded-full">
        <div class="w-1.5 h-1.5 rounded-full" :class="syncStatus ? 'bg-green-400' : 'bg-red-400 animate-pulse'"></div>
        <span class="text-[8px] text-white font-black uppercase tracking-widest">{{ syncStatus ? 'Synced' : 'Offline' }}</span>
    </div>

    <div v-for="n in 12" :key="n" class="snowflake" :style="{left: Math.random()*100+'%', animationDuration: (Math.random()*10+5)+'s', animationDelay: Math.random()*5+'s', top: '-20px'}">‚ùÑ</div>

    <header class="header-bg text-white px-6 pt-12 pb-5 z-30 shadow-lg relative">
        <h1 class="brand-text">HONG KONG</h1>
        <div class="flex items-center space-x-2 opacity-80 mt-1">
            <span class="w-6 h-[1px] bg-hk-gold"></span>
            <p class="text-[9px] font-black uppercase tracking-widest">January , 2026</p>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto hide-scrollbar p-4 relative z-10 pb-24">
        
        <div v-if="currentTab === 'itinerary'">
            <div class="flex mb-5 items-center justify-between">
                <div class="flex space-x-1">
                    <button v-for="d in days" @click="currentDay = d.id" 
                        :class="currentDay === d.id ? 'xmas-red text-white shadow-md' : 'bg-white text-gray-400 border'"
                        class="py-2 px-3 rounded-lg text-[10px] font-black transition-all">DAY {{ d.id }}</button>
                </div>
                <div class="flex items-center space-x-2 bg-white px-3 py-1.5 rounded-full border border-hk-gold/30 shadow-sm">
                    <i :class="days[currentDay-1].icon" class="text-hk-gold text-sm"></i>
                    <span class="text-xs font-black text-xmas-green">{{ days[currentDay-1].temp }}¬∞C</span>
                </div>
            </div>

            <div v-if="currentDay === 1 || currentDay === 3" class="ticket-stub p-5 mb-8 mx-1">
                <div class="flex justify-between items-center border-b-2 border-dashed border-hk-gold/30 pb-2 mb-4 text-[10px] font-black text-xmas-red italic">
                    <span>FLIGHT PASS</span>
                    <span class="text-hk-gold uppercase">{{ currentDay === 1 ? 'Go to HK' : 'Return Home' }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-center">
                        <p class="text-4xl font-black text-xmas-red leading-none">{{ currentDay === 1 ? 'KHH' : 'HKG' }}</p>
                        <p class="text-sm font-black text-xmas-green mt-2">{{ currentDay === 1 ? '07:50' : '20:45' }}</p>
                    </div>
                    <div class="flex-1 border-t-2 border-hk-gold/40 border-dotted relative mx-4"><i class="fas fa-sleigh text-hk-gold absolute -top-3 left-1/2 -translate-x-1/2 text-2xl"></i></div>
                    <div class="text-center">
                        <p class="text-4xl font-black text-xmas-red leading-none">{{ currentDay === 1 ? 'HKG' : 'KHH' }}</p>
                        <p class="text-sm font-black text-xmas-green mt-2">{{ currentDay === 1 ? '09:30' : '22:15' }}</p>
                    </div>
                </div>
            </div>

            <div class="relative pl-16">
                <div v-if="currentDayItems.length > 0" class="timeline-path"></div>
                <div v-for="(item, index) in currentDayItems" :key="index">
                    <div v-if="index > 0" class="relative -left-10 mb-6 flex items-center z-20">
                        <div class="bg-white/80 backdrop-blur-sm border border-hk-gold/40 px-3 py-1 rounded-full shadow-sm flex items-center space-x-2">
                            <i class="fas fa-route text-hk-gold text-[10px]"></i>
                            <input v-model="item.gapInfo" @change="saveData" placeholder="Ëº∏ÂÖ•‰∫§ÈÄöÊôÇÈñì" class="bg-transparent border-none outline-none text-[10px] font-bold text-hk-gold w-32">
                        </div>
                    </div>

                    <div class="mb-10 relative">
                        <div class="absolute -left-16 top-1 w-12 text-right text-[11px] font-black text-xmas-green">{{ item.time }}</div>
                        <div class="absolute -left-[11px] top-1.5 w-3 h-3 rounded-full bg-xmas-red z-10 border-2 border-white"></div>
                        <div class="bg-white rounded-xl overflow-hidden shadow-md border-b-4 border-xmas-green p-3">
                            <img v-if="item.image" :src="item.image" class="w-full h-40 object-cover rounded-lg mb-3">
                            <div class="flex flex-col">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <span v-if="item.tag" class="text-[8px] bg-hk-gold/10 text-hk-gold px-2 py-0.5 rounded-full font-black uppercase mb-1 inline-block">{{ item.tag }}</span>
                                        <h3 class="font-black text-sm text-xmas-green leading-tight">{{ item.location }}</h3>
                                    </div>
                                </div>
                                <p v-if="item.note" class="text-[10px] text-gray-400 mb-4 italic border-l-2 border-hk-gold pl-2">{{ item.note }}</p>
                                <div class="flex justify-between items-center mt-1 pt-2 border-t border-gray-50">
                                    <div class="flex space-x-1">
                                        <a v-if="item.mapUrl" :href="item.mapUrl" target="_blank" class="bg-blue-50 text-blue-500 p-2 rounded-lg flex items-center justify-center"><i class="fas fa-map-marked-alt text-xs"></i></a>
                                        <button @click="editItem(index)" class="bg-amber-50 text-amber-500 p-2 rounded-lg flex items-center justify-center"><i class="fas fa-edit text-[10px]"></i></button>
                                        <button @click="moveItem(index, -1)" class="bg-gray-50 text-gray-400 p-2 rounded-lg flex items-center justify-center"><i class="fas fa-chevron-up text-[10px]"></i></button>
                                        <button @click="moveItem(index, 1)" class="bg-gray-50 text-gray-400 p-2 rounded-lg flex items-center justify-center"><i class="fas fa-chevron-down text-[10px]"></i></button>
                                    </div>
                                    <button @click="deleteItem(index)" class="bg-red-50 text-red-500 p-2 rounded-lg flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'list'" class="space-y-6">
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border-t-4 border-xmas-red">
                <div class="xmas-red p-4 flex justify-between items-center text-white"><h2 class="font-black italic tracking-widest text-sm uppercase"><i class="fas fa-suitcase-rolling mr-2"></i>Packing List</h2></div>
                <div class="p-4 space-y-2">
                    <div v-for="(item, idx) in packingList" :key="idx" @click="item.done = !item.done; saveData()" class="flex items-center justify-between p-3 rounded-xl border transition-all cursor-pointer" :class="item.done ? 'bg-gray-50 opacity-50' : 'bg-white border-hk-gold/10'"><div class="flex items-center space-x-3"><i :class="item.done ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-200'" class="far"></i><span class="text-xs font-bold">{{ item.text }}</span></div><button @click.stop="deleteListItem('packing', idx)" class="text-gray-200 hover:text-red-400"><i class="fas fa-trash-alt"></i></button></div>
                    <div class="flex mt-4 bg-gray-50 rounded-xl p-1"><input v-model="newItemName" placeholder="Êñ∞Â¢ûË°åÊùé..." class="flex-1 bg-transparent p-3 text-xs outline-none font-bold"><button @click="addItem('packing')" class="xmas-red text-white px-5 rounded-lg font-black text-xs">+</button></div>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border-t-4 border-xmas-green">
                <div class="xmas-green p-4 text-white"><h2 class="font-black italic tracking-widest text-sm uppercase"><i class="fas fa-gift mr-2"></i>Shopping List</h2></div>
                <div class="p-4 space-y-2">
                    <div v-for="(item, idx) in shoppingList" :key="idx" @click="item.done = !item.done; saveData()" class="flex items-center justify-between p-3 rounded-xl border border-hk-gold/10 bg-white shadow-sm" :class="item.done ? 'opacity-50' : ''"><div class="flex items-center space-x-3"><i :class="item.done ? 'fa-check-square text-hk-gold' : 'fa-square text-gray-200'" class="far"></i><span class="text-xs font-bold">{{ item.text }}</span></div><button @click.stop="deleteListItem('shopping', idx)" class="text-gray-200 hover:text-red-400"><i class="fas fa-trash-alt"></i></button></div>
                    <div class="flex mt-4 bg-gray-50 rounded-xl p-1"><input v-model="newShopItemName" placeholder="ÊÉ≥Ë≤∑‰ªÄÈ∫ºÂë¢Ôºü" class="flex-1 bg-transparent p-3 text-xs outline-none font-bold"><button @click="addItem('shopping')" class="xmas-green text-white px-5 rounded-lg font-black text-xs">+</button></div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'expense'" class="flex flex-col h-full space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-lg border-2 border-hk-gold/30 text-center relative mx-1">
                <div class="text-[9px] font-black text-hk-gold mb-1 uppercase tracking-widest"><i class="fas fa-sync-alt fa-spin mr-1" v-if="!rateLoaded"></i>Live Rate: 1 HKD ‚âà {{ exchangeRate }} TWD</div>
                <p class="text-[10px] font-black text-gray-400 mb-1">TOTAL EXPENSE</p>
                <p class="text-3xl font-black text-xmas-red mb-4">NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}</p>
                <div class="space-y-2"><input v-model="newEx.name" placeholder="È†ÖÁõÆÂêçÁ®±" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-xs font-bold outline-none"><div class="flex space-x-2"><input v-model.number="newEx.amount" type="number" placeholder="HKD" class="w-1/2 bg-gray-50 border border-gray-200 p-3 rounded-xl text-xs font-bold outline-none"><button @click="addExpense" class="w-1/2 xmas-red text-white py-3 rounded-xl text-xs font-black shadow-md">ADD</button></div></div>
            </div>
            <div class="flex-1 overflow-y-auto space-y-2 pb-24 hide-scrollbar px-1">
                <div v-for="(ex, i) in expenseList" :key="i" class="flex items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100"><div class="flex-1 min-w-0 pr-3"><p class="font-black text-sm text-xmas-green truncate">{{ ex.name }}</p><p class="text-[9px] font-bold text-hk-gold">‚âà NT$ {{ Math.round(ex.amount * exchangeRate).toLocaleString() }}</p></div><div class="flex items-center space-x-2 shrink-0"><span class="font-black text-xmas-red text-sm">${{ ex.amount }}</span><button @click="deleteExpense(i)" class="text-gray-300 active:text-red-500 p-1"><i class="fas fa-times-circle text-lg"></i></button></div></div>
            </div>
        </div>
    </main>

    <button v-if="currentTab === 'itinerary'" @click="openAddModal" class="fixed bottom-32 right-6 w-14 h-14 xmas-red text-white rounded-full shadow-2xl z-[60] flex items-center justify-center border-4 border-white active:scale-95 transition-all"><i class="fas fa-plus text-xl"></i></button>

    <transition name="modal">
        <div v-if="showModal" class="fixed inset-0 z-[100] flex items-end md:items-center justify-center p-0 md:p-6">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-md" @click="closeModal"></div>
            <div class="bg-white w-full max-w-lg rounded-t-[40px] md:rounded-[40px] shadow-2xl z-10 overflow-hidden border-t-8 border-xmas-red flex flex-col max-h-[80vh] mb-[80px] md:mb-0">
                <div class="p-8 overflow-y-auto space-y-6 hide-scrollbar relative">
                    <div class="flex justify-between items-center border-b border-gray-100 pb-4">
                        <div>
                            <h2 class="font-black text-xmas-red italic uppercase tracking-widest text-xl leading-none">{{ editingIndex === null ? 'Add Spot' : 'Edit Spot' }}</h2>
                            <p class="text-[9px] text-gray-400 font-black mt-1 uppercase tracking-tighter">Capture the magic of Hong Kong</p>
                        </div>
                        <button @click="closeModal" class="text-gray-300"><i class="fas fa-times-circle text-2xl"></i></button>
                    </div>
                    
                    <div class="group relative aspect-video bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200 flex items-center justify-center overflow-hidden transition-all hover:border-hk-gold">
                        <div v-if="isCropping" class="w-full h-full relative crop-container bg-black z-20">
                            <img ref="cropImg" :src="tempImageSrc" class="max-w-full">
                            <div class="absolute bottom-4 right-4 flex space-x-2 z-30">
                                <button @click.stop="cancelCrop" class="bg-white/20 backdrop-blur-md text-white w-10 h-10 rounded-full flex items-center justify-center border border-white/50"><i class="fas fa-times"></i></button>
                                <button @click.stop="confirmCrop" class="bg-xmas-red text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg border-2 border-white"><i class="fas fa-check"></i></button>
                            </div>
                        </div>
                        <template v-else>
                            <img v-if="newItem.image" :src="newItem.image" class="w-full h-full object-cover z-10">
                            <div v-else class="text-center text-gray-300 z-0">
                                <div class="w-12 h-12 bg-white rounded-full shadow-md flex items-center justify-center mx-auto mb-2 text-xmas-red"><i class="fas fa-camera text-xl"></i></div>
                                <p class="text-[10px] font-black uppercase tracking-widest">Tap to Upload & Crop</p>
                            </div>
                            <input type="file" @change="handleImageUpload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-20">
                        </template>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-1"><label class="text-[10px] font-black text-hk-gold block mb-1">Time</label><input v-model="newItem.time" type="time" class="w-full bg-gray-50 p-3 rounded-2xl text-xs font-black"></div>
                        <div class="col-span-2"><label class="text-[10px] font-black text-hk-gold block mb-1">Location Name</label><input v-model="newItem.location" placeholder="Ë¶ÅÂéªÂì™Ë£°Ôºü" class="w-full bg-gray-50 p-3 rounded-2xl text-xs font-black"></div>
                    </div>
                    <div class="space-y-4 bg-gray-50/50 p-4 rounded-3xl">
                        <input v-model="newItem.mapUrl" placeholder="Google Map ÈÄ£Áµê..." class="w-full bg-white p-3 rounded-2xl text-[10px] font-bold border-none shadow-sm">
                        <div class="flex flex-wrap gap-2"><button v-for="tag in ['üì∏ ÊôØÈªû', 'üçΩÔ∏è ÁæéÈ£ü', 'üõçÔ∏è Ë≥ºÁâ©', 'üöå ‰∫§ÈÄö','üè† ‰ΩèÂÆø']" @click="newItem.tag = tag" :class="newItem.tag === tag ? 'xmas-green text-white' : 'bg-white text-gray-400 border'" class="px-4 py-2 rounded-full text-[10px] font-black">{{ tag }}</button></div>
                    </div>
                    <textarea v-model="newItem.note" rows="3" placeholder="ÂÇôË®ª..." class="w-full bg-gray-50 p-4 rounded-2xl text-xs font-bold border-none outline-none"></textarea>
                </div>
                <div class="p-6 bg-gray-50 flex space-x-4 border-t border-gray-100">
                    <button @click="closeModal" class="flex-1 py-4 font-black text-gray-400 text-[10px] uppercase">Discard</button>
                    <button @click="addItineraryItem" class="flex-[2] xmas-red text-white py-4 rounded-2xl font-black text-xs uppercase shadow-xl">{{ editingIndex === null ? 'Save To Itinerary' : 'Update Spot' }}</button>
                </div>
            </div>
        </div>
    </transition>

    <nav class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-100 flex justify-around p-3 pb-8 z-[100]">
        <button v-for="t in tabs" @click="currentTab = t.id" :class="currentTab === t.id ? 'text-xmas-red scale-110' : 'text-[var(--xmas-green)]'" class="flex flex-col items-center space-y-1 transition-all"><i :class="t.icon" class="text-xl"></i><span class="text-[8px] font-black uppercase tracking-tighter">{{ t.name }}</span></button>
    </nav>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyCgpe5pVDiX_e7kvgTINptcmqYXtX7V854", authDomain: "hongkong-c21fd.firebaseapp.com", databaseURL: "https://hongkong-c21fd-default-rtdb.firebaseio.com", projectId: "hongkong-c21fd", storageBucket: "hongkong-c21fd.firebasestorage.app", messagingSenderId: "519310424430", appId: "1:519310424430:web:73b13ae9d21e12a818297f" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const { createApp, nextTick } = Vue;
createApp({
    data() {
        return {
            currentTab: 'itinerary', currentDay: 1, syncStatus: false, showModal: false, editingIndex: null, exchangeRate: 4.12, rateLoaded: false,
            tabs: [{id:'itinerary', name:'Ë°åÁ®ã', icon:'fas fa-sleigh'}, {id:'list', name:'Ê∏ÖÂñÆ', icon:'fa-solid fa-candy-cane'}, {id:'expense', name:'Ë®òÂ∏≥', icon:'fa-solid fa-piggy-bank'}],     
            days: [{id:1, temp:'--', icon:'fas fa-spinner fa-spin'}, {id:2, temp:'--', icon:'fas fa-spinner fa-spin'}, {id:3, temp:'--', icon:'fas fa-spinner fa-spin'}],
            itinerary: [[], [], []], 
            newItem: {time: '12:00', location: '', image: '', mapUrl: '', tag: 'üì∏ ÊôØÈªû', note: '', gapInfo: ''},
            packingList: [], shoppingList: [], expenseList: [], newItemName: '', newShopItemName: '', newEx:{name:'', amount:null},
            isCropping: false, tempImageSrc: '', cropper: null
        }
    },
    computed: {
        currentDayItems() { return this.itinerary[this.currentDay-1] || []; },
        totalExpense() { return this.expenseList.reduce((sum, i)=> sum + (parseFloat(i.amount)||0), 0); }
    },
    methods: {
        async fetchExchangeRate() { try { const res = await fetch('https://api.frankfurter.app/latest?from=HKD&to=TWD'); const data = await res.json(); if (data && data.rates && data.rates.TWD) { this.exchangeRate = data.rates.TWD.toFixed(2); this.rateLoaded = true; } } catch (e) {} },
        openAddModal() { this.editingIndex = null; this.newItem = {time: '12:00', location: '', image: '', mapUrl: '', tag: 'üì∏ ÊôØÈªû', note: '', gapInfo: ''}; this.showModal = true; },
        editItem(idx) { this.editingIndex = idx; const item = this.currentDayItems[idx]; this.newItem = { ...item }; this.showModal = true; },
        closeModal() { this.showModal = false; this.editingIndex = null; this.cancelCrop(); },
        
        // ‰øÆÊ≠£ÂæåÁöÑ addItineraryItemÔºöÁ¢∫‰øùÁõÆÊ®ôÈô£ÂàóÂ≠òÂú®
        addItineraryItem() { 
            if(!this.newItem.location) return; 
            const dayIdx = this.currentDay - 1;
            // Â¶ÇÊûúË©≤Â§©ÈÇÑÊ≤íË¢´ÂàùÂßãÂåñÔºåÊâãÂãïË£ú‰∏äÁ©∫Èô£Âàó
            if (!this.itinerary[dayIdx]) {
                this.itinerary[dayIdx] = [];
            }
            if(this.editingIndex !== null) { 
                this.itinerary[dayIdx][this.editingIndex] = {...this.newItem}; 
            } else { 
                this.itinerary[dayIdx].push({...this.newItem}); 
            } 
            this.closeModal(); 
            this.saveData(); 
        },

        handleImageUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { this.tempImageSrc = event.target.result; this.isCropping = true; nextTick(() => { this.startCropper(); }); }; reader.readAsDataURL(file); e.target.value = ''; },
        startCropper() { if (this.cropper) { this.cropper.destroy(); } const image = this.$refs.cropImg; this.cropper = new Cropper(image, { aspectRatio: 16 / 9, viewMode: 1, dragMode: 'move', autoCropArea: 1, background: false }); },
        confirmCrop() { if (!this.cropper) return; const canvas = this.cropper.getCroppedCanvas({ maxWidth: 800 }); this.newItem.image = canvas.toDataURL('image/jpeg', 0.7); this.cancelCrop(); },
        cancelCrop() { this.isCropping = false; this.tempImageSrc = ''; if (this.cropper) { this.cropper.destroy(); this.cropper = null; } },
        async fetchWeather() { try { const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=22.2855&longitude=114.1577&daily=weathercode,temperature_2m_max&timezone=Asia%2FHong_Kong'); const data = await res.json(); const iconMap = code => code <= 1 ? 'fas fa-sun' : code <= 3 ? 'fas fa-cloud-sun' : 'fas fa-cloud'; for(let i=0; i<3; i++) { this.days[i].temp = Math.round(data.daily.temperature_2m_max[i]); this.days[i].icon = iconMap(data.daily.weathercode[i]); } } catch (e) {} },
        
        // ‰øÆÊ≠£ÂæåÁöÑÂêåÊ≠•ÈÇèËºØÔºöÁ¢∫‰øùÈô£ÂàóÂßãÁµÇÊúâ 3 Â§©
        initSync() { 
            db.ref('trip_data').on('value', (snapshot) => { 
                const data = snapshot.val(); 
                if (data) { 
                    let fetchedItinerary = data.itinerary || [];
                    // Â¶ÇÊûúËÆÄÂèñÂà∞ÁöÑÂ§©Êï∏Â∞ëÊñº 3 Â§©ÔºåËá™ÂãïË£úÈΩä
                    while(fetchedItinerary.length < 3) {
                        fetchedItinerary.push([]);
                    }
                    this.itinerary = fetchedItinerary;
                    this.packingList = data.packingList || []; 
                    this.shoppingList = data.shoppingList || []; 
                    this.expenseList = data.expenseList || []; 
                } else {
                    this.itinerary = [[], [], []];
                }
                this.syncStatus = true; 
            }); 
        },

        saveData() { db.ref('trip_data').set({ itinerary: this.itinerary, packingList: this.packingList, shoppingList: this.shoppingList, expenseList: this.expenseList }); },
        deleteItem(idx) { if(confirm('Á¢∫ÂÆöÂà™Èô§ÂóéÔºü')) { this.itinerary[this.currentDay-1].splice(idx, 1); this.saveData(); } },
        moveItem(idx, dir) { let list = this.itinerary[this.currentDay-1]; if ((dir === -1 && idx > 0) || (dir === 1 && idx < list.length - 1)) { const item = list.splice(idx, 1)[0]; list.splice(idx + dir, 0, item); this.saveData(); } },
        addItem(type) { if(type === 'packing' && this.newItemName) { this.packingList.push({text: this.newItemName, done: false}); this.newItemName = ''; } else if(type === 'shopping' && this.newShopItemName) { this.shoppingList.push({text: this.newShopItemName, done: false}); this.newShopItemName = ''; } this.saveData(); },
        deleteListItem(type, idx) { if(type === 'packing') this.packingList.splice(idx, 1); else if(type === 'shopping') this.shoppingList.splice(idx, 1); this.saveData(); },
        addExpense() { if (this.newEx.name && this.newEx.amount) { this.expenseList.push({...this.newEx}); this.newEx={name:'', amount:null}; this.saveData(); } },
        deleteExpense(i) { this.expenseList.splice(i, 1); this.saveData(); }
    },
    mounted() { this.initSync(); this.fetchWeather(); this.fetchExchangeRate(); }
}).mount('#app');
</script>
</body>
</html>